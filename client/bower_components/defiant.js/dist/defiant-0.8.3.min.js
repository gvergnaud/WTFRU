/* 
 * Defiant.js v0.8.3 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
(function(e,t){"use strict";var n={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:null!==navigator.userAgent.match(/safari/i),render:function(e,n){var r,s,o=new XSLTProcessor,a=t.createElement("span"),i={match:"/"};switch(typeof e){case"object":this.extend(i,e),i.data||(i.data=n);break;case"string":i.template=e,i.data=n;break;default:throw"error"}if(i.data=JSON.toXML(i.data),this.xsl_template||this.gather_templates(),s=this.xsl_template.selectSingleNode('//xsl:template[@name="'+i.template+'"]'),s.setAttribute("match",i.match),o.importStylesheet(this.xsl_template),a.appendChild(o.transformToFragment(i.data,t)),s.removeAttribute("match"),this.is_safari){r=a.getElementsByTagName("script");for(var l=0,c=r.length;c>l;l++)r[l].defer=!0}return a.innerHTML},gather_templates:function(){for(var e=t.getElementsByTagName("script"),n="defiant/xsl-template",r="",s=0,o=e.length;o>s;s++)e[s].type===n&&(r+=e[s].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+r.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(t){var n,r;return t=t.replace(/>\s{1,}</g,"><"),null===t.match(/<\?xml/)&&(t=this.xml_decl+t),e.DOMParser?(n=new DOMParser,r=n.parseFromString(t,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(t)),r},extend:function(e,t){for(var n in t)e[n]&&"object"==typeof t[n]?this.extend(e[n],t[n]):e[n]=t[n];return e}};e.Defiant=n})(window,document),String.prototype.fill||(String.prototype.fill=function(e,t){var n=this;for(t=t||" ";e>n.length;n+=t);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),Document.selectNodes||(Document.prototype.selectNodes=function(e,t){t||(t=this),this.ns=this.createNSResolver(this.documentElement),this.qI=this.evaluate(e,t,this.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var n=[],r=0,s=this.qI.snapshotLength;s>r;r++)n.push(this.qI.snapshotItem(r));return n}),Node.selectNodes||(Node.prototype.selectNodes=function(e){return this.ownerDocument.selectNodes(e,this)}),Document.selectSingleNode||(Document.prototype.selectSingleNode=function(e,t){return t||(t=this),this.xI=this.selectNodes(e,t),this.xI.length>0?this.xI[0]:null}),Node.selectSingleNode||(Node.prototype.selectSingleNode=function(e){return this.ownerDocument.selectSingleNode(e,this)}),Node.xml||Node.prototype.__defineGetter__("xml",function(){var e=Defiant.tabsize,t=Defiant.xml_decl.toLowerCase(),n=new XMLSerializer,r=n.serializeToString(this);"development"!==Defiant.env&&(r=r.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var s,o,a=r.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),i=a.split("\n"),l=-1,c=0,u=i.length;u>c;c++)(0!==c||i[c].toLowerCase()!==t)&&(s=null!==i[c].match(/<[^\/]+>/g),o=null!==i[c].match(/<\/[\w\:]+>/g),null!==i[c].match(/<.*?\/>/g)&&(s=o=!0),s&&l++,i[c]="".fill(l,"	")+i[c],s&&o&&l--,!s&&o&&l--);return i.join("\n").replace(/\t/g,"".fill(e," "))}),Node.text||(Node.prototype.__defineGetter__("text",function(){return this.textContent}),Node.prototype.__defineSetter__("text",function(e){this.textContent=e})),Node.toJSON||(Node.prototype.toJSON=function(e){"use strict";var t=function(e){var n,r,s,o,a,i,l={};switch(e.nodeType){case 1:r=e.getAttribute("d:constr"),"Array"===r&&(l=[]),n=e.attributes;for(var c,u=0,h=n.length;h>u;u++)c=n.item(u),null===c.nodeName.match(/\:d|d\:/g)&&(r=e.getAttribute("d:"+c.nodeName),i=r?window[r]("false"===c.nodeValue?"":c.nodeValue):c.nodeValue,l["@"+c.nodeName]=i);break;case 3:r=e.parentNode.getAttribute("d:type"),i=r?window[r]("false"===e.nodeValue?"":e.nodeValue):e.nodeValue,l=i}if(e.hasChildNodes())for(var d=0,f=e.childNodes.length;f>d;d++)if(s=e.childNodes.item(d),o=s.nodeName,n=e.attributes,"#text"===o)a=e.getAttribute("d:constr"),i="Boolean"===a&&"false"===s.textContent?"":s.textContent,a||n.length?a&&1===n.length?l=window[a](i):l[o]=a?window[a](i):i:l=i;else{if(l[o]){l[o].push?l[o].push(t(s)):l[o]=[l[o],t(s)];continue}switch(a=s.getAttribute("d:constr")){case"null":l.push?l.push(null):l[o]=null;break;case"Array":s.parentNode.firstChild===s&&"Array"===s.getAttribute("d:constr")&&"item"!==o?l[o]=[t(s)]:l.push?l.push(t(s)):l[o]=t(s);break;case"String":case"Number":case"Boolean":i="Boolean"===a&&"false"===s.textContent?"":s.textContent,l.push?l.push(window[a](i)):l[o]=t(s);break;default:l.push?l.push(t(s)):l[o]=t(s)}}return l},n=9===this.nodeType?this.documentElement:this,r=t(n),s=r[n.nodeName];return n===n.ownerDocument.documentElement&&s&&s.constructor===Array&&(r=s),e?JSON.stringify(r,null,"	"):r}),window.JSON||(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(e){if(e instanceof Object){var t="";if(e.constructor===Array){for(var n=0;e.length>n;t+=this.stringify(e[n])+",",n++);return"["+t.substr(0,t.length-1)+"]"}if(e.toString!==Object.prototype.toString)return'"'+(""+e).replace(/"/g,"\\$&")+'"';for(var r in e)t+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(e[r])+",";return"{"+t.substr(0,t.length-1)+"}"}return"string"==typeof e?'"'+e.replace(/"/g,"\\$&")+'"':e+""}}),JSON.toXML||(JSON.toXML=function(e){"use strict";var t={repl:function(e){for(var t in this)delete this[t];Defiant.extend(this,e)},to_xml:function(e){var t=this.hash_to_xml(null,e);return Defiant.xmlFromString(t)},hash_to_xml:function(e,t,n){var r,s,o,a,i,l,c=t.constructor===Array,u=[],h=[];for(r in t)if(s=t[r],(null===s||"NaN"==""+s)&&(s=null),a="@"===r.slice(0,1),i=n?e:r,i=i==+i?"item":i,l=null===s?null:s.constructor,a)h.push(i.slice(1)+'="'+this.escape_xml(s)+'"'),"String"!==l.name&&h.push("d:"+i.slice(1)+'="'+l.name+'"');else if(null===s)u.push(this.scalar_to_xml(i,s));else switch(l){case Object:u.push(this.hash_to_xml(i,s));break;case Array:if(r===i){if(o=s.constructor===Array)for(var d=0,f=s.length;f>d;d++)s[d].constructor===Array&&(o=!0),o||s[d].constructor!==Object||(o=!0);u.push(this.scalar_to_xml(i,s,o));break}case String:"string"==typeof s&&(s=(""+s).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===i&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),u.push(this.scalar_to_xml(i,s));break;default:throw"ERROR! "+r}return e||(e="data",h.push(Defiant.namespace),c&&h.push('d:constr="Array"')),n?u.join(""):"<"+e+(h.length?" "+h.join(" "):"")+(u.length?">"+u.join("")+"</"+e+">":"/>")},scalar_to_xml:function(e,t,n){var r,s,o;return(null===t||"NaN"==""+t)&&(t=null),null===t?"<"+e+' d:constr="null"/>':n?this.hash_to_xml(e,t,!0):(o=t.constructor,r=o===Array?this.hash_to_xml("item",t,!0):this.escape_xml(t),s=' d:constr="'+o.name+'"',"String"===o.name&&(s=""),"#text"===e?this.escape_xml(t):"<"+e+s+">"+r+"</"+e+">")},escape_xml:function(e){return(e+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},n=t.to_xml.call(t,e);return t.repl.call(e,n.documentElement.toJSON()),n}),JSON.search||(JSON.search=function(e,t,n){"use strict";var r,s,o,a,i,l,c,u,h,d,f=JSON.toXML(e),m=f.documentElement,p=f[n?"selectSingleNode":"selectNodes"](t),g=[],N=Defiant.trace?[]:!1,x=function(){if(!(d.indexOf(a)>-1)&&(d.push(a),g[_].length-1>a)){var e=i.val.replace(/\t/g,""),t=g[_][a+1].val.replace(/\t/g,""),n=e.indexOf(t);c+=n}},y=function(e){if(a===g[_].length)return e;switch(e.constructor){case Array:N&&x();for(var t,n=e.length,r=0;n>r;r++)if(i.val===JSON.stringify(e[r],null,"	")&&g[_].length>a)return a++,i=g[_][a],y(e[r]);if(r===n){if(i.val===JSON.stringify(e,null,"	"))for(a++,i=g[_][a],r=0;n>r;r++)if(t=y(e[r]))return t;return e}break;default:if(N&&x(),e=e[i.key],"object"!=typeof e)return a++,i=g[_][a],e;e.constructor===Object&&(a++,i=g[_][a])}return y(e)};for(n&&(p=[p]),_=0,S=p.length;S>_;_++)if(s=[],o=p[_],o!==m){for(;o!==f.documentElement;)l=2===o.nodeType,s.push({node:o,key:(l?"@":"")+o.nodeName,val:l?o.value:o.toJSON(!0)}),o=l?o.ownerElement:o.parentNode;g.push(s.reverse())}for(var _=0,S=g.length;S>_;_++)u=0,c=0,d=[],a=0,i=g[_][a],r=y(e),N&&(u=c?g[_][0].val.replace(/\t/g,"").slice(0,c).match(/\n/g).length:0,h=g[_][a-1].val.match(/\n/g),N.push([u+2,null===h?0:h.length])),g[_]=r;return N?this.trace=N:delete this.trace,g}),"undefined"!=typeof jQuery&&function(e){"use strict";e.fn.defiant=function(e,t){return this.html(Defiant.render(e,t)),this}}(jQuery);