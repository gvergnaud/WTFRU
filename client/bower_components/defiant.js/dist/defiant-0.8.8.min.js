/* 
 * Defiant.js v0.8.8 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
if("undefined"==typeof module)module={exports:void 0};else{var dom=require("xmldom");this.Document=Document=dom.DOMImplementation,this.DOMParser=DOMParser=dom.DOMParser,this.XMLSerializer=XMLSerializer=dom.XMLSerializer,document=(new Document).createDocument(null,null,null)}module.exports=Defiant=function(t){"use strict";var e={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:"undefined"!=typeof navigator?null!==navigator.userAgent.match(/safari/i):!1,render:function(t,e){var r,n,a=new XSLTProcessor,s=document.createElement("span"),i={match:"/"};switch(typeof t){case"object":this.extend(i,t),i.data||(i.data=e);break;case"string":i.template=t,i.data=e;break;default:throw"error"}if(i.data=JSON.toXML(i.data),this.xsl_template||this.gather_templates(),n=this.xsl_template.selectSingleNode('//xsl:template[@name="'+i.template+'"]'),n.setAttribute("match",i.match),a.importStylesheet(this.xsl_template),s.appendChild(a.transformToFragment(i.data,document)),n.removeAttribute("match"),this.is_safari){r=s.getElementsByTagName("script");for(var o=0,l=r.length;l>o;o++)r[o].defer=!0}return s.innerHTML},gather_templates:function(){for(var t=document.getElementsByTagName("script"),e="",r=0,n=t.length;n>r;r++)"defiant/xsl-template"===t[r].type&&(e+=t[r].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+e.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(e){var r,n;return null===e.match(/<\?xml/)&&(e=this.xml_decl+e),t.DOMParser?(r=new DOMParser,n=r.parseFromString(e,"text/xml")):(n=new ActiveXObject("Microsoft.XMLDOM"),n.async="false",n.loadXML(e)),n},extend:function(t,e){for(var r in e)t[r]&&"object"==typeof e[r]?this.extend(t[r],e[r]):t[r]=e[r];return t},prettyPrint:function(t){var e=this.tabsize,r=this.xml_decl.toLowerCase(),n=new XMLSerializer,a=n.serializeToString(t);"development"!==this.env&&(a=a.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var s,i,o=a.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),l=o.split("\n"),u=-1,c=0,h=l.length;h>c;c++)(0!==c||l[c].toLowerCase()!==r)&&(s=null!==l[c].match(/<[^\/]+>/g),i=null!==l[c].match(/<\/[\w\:]+>/g),null!==l[c].match(/<.*?\/>/g)&&(s=i=!0),s&&u++,l[c]="".fill(u,"	")+l[c],s&&i&&u--,!s&&i&&u--);return l.join("\n").replace(/\t/g,"".fill(e," "))},selectNodes:function(t,e,r){r||(r=t),t.ns=t.createNSResolver(t.documentElement),t.qI=t.evaluate(e,r,t.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var n=[],a=0,s=t.qI.snapshotLength;s>a;a++)n.push(t.qI.snapshotItem(a));return n},selectSingleNode:function(t,e,r){return r||(r=t),t.xI=t.selectNodes(e,r),t.xI.length>0?t.xI[0]:null},nodeToJSON:function(e,r){var n=function(e){var r,a,s,i,o,l,u={};switch(e.nodeType){case 1:a=e.getAttribute("d:constr"),"Array"===a&&(u=[]),r=e.attributes;for(var c,h=0,f=r.length;f>h;h++)c=r.item(h),null===c.nodeName.match(/\:d|d\:/g)&&(a=e.getAttribute("d:"+c.nodeName),l=a?t[a]("false"===c.nodeValue?"":c.nodeValue):c.nodeValue,u["@"+c.nodeName]=l);break;case 3:a=e.parentNode.getAttribute("d:type"),l=a?t[a]("false"===e.nodeValue?"":e.nodeValue):e.nodeValue,u=l}if(e.hasChildNodes())for(var m=0,p=e.childNodes.length;p>m;m++)if(s=e.childNodes.item(m),i=s.nodeName,r=e.attributes,"#text"===i)o=e.getAttribute("d:constr"),l="Boolean"===o&&"false"===s.textContent?"":s.textContent,o||r.length?o&&1===r.length?u=t[o](l):u[i]=o?t[o](l):l:u=l;else{if(u[i]){u[i].push?u[i].push(n(s)):u[i]=[u[i],n(s)];continue}switch(o=s.getAttribute("d:constr")){case"null":u.push?u.push(null):u[i]=null;break;case"Array":s.parentNode.firstChild===s&&"Array"===s.getAttribute("d:constr")&&"item"!==i?u[i]=[n(s)]:u.push?u.push(n(s)):u[i]=n(s);break;case"String":case"Number":case"Boolean":l="Boolean"===o&&"false"===s.textContent?"":s.textContent,u.push?u.push(t[o](l)):u[i]=n(s);break;default:u.push?u.push(n(s)):u[i]=n(s)}}return u},e=9===e.nodeType?e.documentElement:e,a=n(e),s=a[e.nodeName];return e===e.ownerDocument.documentElement&&s&&s.constructor===Array&&(a=s),r&&"true"==""+r&&(r="	"),r?JSON.stringify(a,null,r):a},result:function(){var t=function(e){var r=Object.create(Array.prototype);for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(r[n]=t.prototype[n]);for(var a=0,s=e.length;s>a;a++)r.push(e[a]);return r};return t.prototype={toArray:function(){return Array.prototype.slice.call(this,0)},sum:function(t){for(var e=0,r=this.length,n=0;r>e;e++)n+=+this[e][t];return n},avg:function(t){return this.sum(t)/this.length},min:function(t,e){for(var r=0,n=this.length,a=[];n>r;r++)a.push(this[r][t]);return Math[e||"min"].apply(null,a)},max:function(t){return this.min(t,"max")},add:function(t,e,r){for(var n=0,a=this.length,s="string"==typeof e;a>n;n++)switch(r){case"divide":this[n][t]/=s?this[n][e]:+e;break;case"multiply":this[n][t]*=s?this[n][e]:+e;break;case"subtract":this[n][t]-=s?this[n][e]:+e;break;default:this[n][t]+=s?this[n][e]:+e}return this},subtract:function(t,e){return this.add(t,e,"subtract")},divide:function(t,e){return this.add(t,e,"divide")},multiply:function(t,e){return this.add(t,e,"multiply")},each:function(t){for(var e=0,r=this.length;r>e;e++)t(this[e]);return this}},new t(arguments[0])}};return e}(this),String.prototype.fill||(String.prototype.fill=function(t,e){var r=this;for(e=e||" ";t>r.length;r+=e);return r}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var r=0;t.length>r;e+=this.stringify(t[r])+",",r++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var n in t)e+='"'+n.replace(/"/g,"\\$&")+'":'+this.stringify(t[n])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={repl:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,r){var n,a,s,i,o,l,u=e.constructor===Array,c=[],h=[];for(n in e)if(a=e[n],(null===a||"NaN"==""+a)&&(a=null),i="@"===n.slice(0,1),o=r?t:n,o=o==+o?"item":o,l=null===a?null:a.constructor,i)h.push(o.slice(1)+'="'+this.escape_xml(a)+'"'),"String"!==l.name&&h.push("d:"+o.slice(1)+'="'+l.name+'"');else if(null===a)c.push(this.scalar_to_xml(o,a));else switch(l){case Object:c.push(this.hash_to_xml(o,a));break;case Array:if(n===o){if(s=a.constructor===Array)for(var f=0,m=a.length;m>f;f++)a[f].constructor===Array&&(s=!0),s||a[f].constructor!==Object||(s=!0);c.push(this.scalar_to_xml(o,a,s));break}case String:"string"==typeof a&&(a=(""+a).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===o&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),c.push(this.scalar_to_xml(o,a));break;default:throw"ERROR! "+n}return t||(t="d:data",h.push(Defiant.namespace),u&&h.push('d:constr="Array"')),r?c.join(""):"<"+t+(h.length?" "+h.join(" "):"")+(c.length?">"+c.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,r){var n,a,s;return(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':r?this.hash_to_xml(t,e,!0):(s=e.constructor,n=s===Array?this.hash_to_xml("item",e,!0):this.escape_xml(e),a=' d:constr="'+s.name+'"',"String"===s.name&&(a=""),"#text"===t?this.escape_xml(e):"<"+t+a+">"+n+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},r=e.to_xml.call(e,t);return e.repl.call(t,Defiant.nodeToJSON(r.documentElement)),r}),JSON.search||(JSON.search=function(t,e,r){"use strict";var n,a,s,i,o,l=JSON.toXML(t),u=l.documentElement,c=Defiant[r?"selectSingleNode":"selectNodes"](l,e),h=[],f=[],m=function(t){if(s===h[p].length)return t;switch(t.constructor){case Array:for(var e,r=t.length,n=0;r>n;n++)if(i.val===JSON.stringify(t[n],null,"	")&&h[p].length>s)return s++,i=h[p][s],m(t[n]);if(n===r){if(i.val===JSON.stringify(t,null,"	"))for(s++,i=h[p][s],n=0;r>n;n++)if(e=m(t[n]))return e;return t}break;default:if(t=t[i.key],"object"!=typeof t)return s++,i=h[p][s],t;t.constructor===Object&&(s++,i=h[p][s])}return m(t)};for(r&&(c=[c]),p=0,d=c.length;d>p;p++)if(n=[],a=c[p],a!==u){for(;a!==u;)o=2===a.nodeType,n.push({node:a,key:(o?"@":"")+a.nodeName,val:o?a.value:Defiant.nodeToJSON(a,"	")}),a=o?a.ownerElement:a.parentNode;h.push(n.reverse())}for(var p=0,d=h.length;d>p;p++)s=0,i=h[p][s],f.push(m(t));return this.trace=JSON.search.trace?JSON.mtrace(t,h):!1,Defiant.result(f)}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var r,n,a,s,i,o,l,u=[],c=JSON.stringify(t,null,"	").notabs(),h=0,f=e.length;f>h;h++){n=e[h],i=0,r=c,a=n.length,s=null===n[a-1].val.match(/[\{\}:\[\]]/g),s&&a--,n[0].val.notabs()!==c&&a>0&&(r=n[0].val.notabs(),i+=c.indexOf(r));for(var m=0,p=a;p>m;m++)i+=r.indexOf(n[m].val.notabs()),r=n[m].val.notabs();s&&(i+=r.indexOf('"'+n[m].key+'": ')),o=c.slice(0,i).count_nl()+1,l=n[s?a:a-1].val.count_nl(),u.push([o,l])}return u}),"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);