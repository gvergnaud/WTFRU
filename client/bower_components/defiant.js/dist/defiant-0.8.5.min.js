/* 
 * Defiant.js v0.8.5 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
(function(t,e){"use strict";var n={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:null!==navigator.userAgent.match(/safari/i),render:function(t,n){var r,o,s=new XSLTProcessor,a=e.createElement("span"),i={match:"/"};switch(typeof t){case"object":this.extend(i,t),i.data||(i.data=n);break;case"string":i.template=t,i.data=n;break;default:throw"error"}if(i.data=JSON.toXML(i.data),this.xsl_template||this.gather_templates(),o=this.xsl_template.selectSingleNode('//xsl:template[@name="'+i.template+'"]'),o.setAttribute("match",i.match),s.importStylesheet(this.xsl_template),a.appendChild(s.transformToFragment(i.data,e)),o.removeAttribute("match"),this.is_safari){r=a.getElementsByTagName("script");for(var l=0,c=r.length;c>l;l++)r[l].defer=!0}return a.innerHTML},gather_templates:function(){for(var t=e.getElementsByTagName("script"),n="",r=0,o=t.length;o>r;r++)"defiant/xsl-template"===t[r].type&&(n+=t[r].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+n.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(e){var n,r;return e=e.replace(/>\s{1,}</g,"><"),null===e.match(/<\?xml/)&&(e=this.xml_decl+e),t.DOMParser?(n=new DOMParser,r=n.parseFromString(e,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(e)),r},extend:function(t,e){for(var n in e)t[n]&&"object"==typeof e[n]?this.extend(t[n],e[n]):t[n]=e[n];return t}};t.Defiant=n})(window,document),String.prototype.fill||(String.prototype.fill=function(t,e){var n=this;for(e=e||" ";t>n.length;n+=e);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),Document.selectNodes||(Document.prototype.selectNodes=function(t,e){e||(e=this),this.ns=this.createNSResolver(this.documentElement),this.qI=this.evaluate(t,e,this.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var n=[],r=0,o=this.qI.snapshotLength;o>r;r++)n.push(this.qI.snapshotItem(r));return n}),Node.selectNodes||(Node.prototype.selectNodes=function(t){return this.ownerDocument.selectNodes(t,this)}),Document.selectSingleNode||(Document.prototype.selectSingleNode=function(t,e){return e||(e=this),this.xI=this.selectNodes(t,e),this.xI.length>0?this.xI[0]:null}),Node.selectSingleNode||(Node.prototype.selectSingleNode=function(t){return this.ownerDocument.selectSingleNode(t,this)}),Node.xml||Node.prototype.__defineGetter__("xml",function(){var t=Defiant.tabsize,e=Defiant.xml_decl.toLowerCase(),n=new XMLSerializer,r=n.serializeToString(this);"development"!==Defiant.env&&(r=r.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var o,s,a=r.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),i=a.split("\n"),l=-1,c=0,u=i.length;u>c;c++)(0!==c||i[c].toLowerCase()!==e)&&(o=null!==i[c].match(/<[^\/]+>/g),s=null!==i[c].match(/<\/[\w\:]+>/g),null!==i[c].match(/<.*?\/>/g)&&(o=s=!0),o&&l++,i[c]="".fill(l,"	")+i[c],o&&s&&l--,!o&&s&&l--);return i.join("\n").replace(/\t/g,"".fill(t," "))}),Node.text||(Node.prototype.__defineGetter__("text",function(){return this.textContent}),Node.prototype.__defineSetter__("text",function(t){this.textContent=t})),Node.toJSON||(Node.prototype.toJSON=function(t){"use strict";var e=function(t){var n,r,o,s,a,i,l={};switch(t.nodeType){case 1:r=t.getAttribute("d:constr"),"Array"===r&&(l=[]),n=t.attributes;for(var c,u=0,h=n.length;h>u;u++)c=n.item(u),null===c.nodeName.match(/\:d|d\:/g)&&(r=t.getAttribute("d:"+c.nodeName),i=r?window[r]("false"===c.nodeValue?"":c.nodeValue):c.nodeValue,l["@"+c.nodeName]=i);break;case 3:r=t.parentNode.getAttribute("d:type"),i=r?window[r]("false"===t.nodeValue?"":t.nodeValue):t.nodeValue,l=i}if(t.hasChildNodes())for(var f=0,d=t.childNodes.length;d>f;f++)if(o=t.childNodes.item(f),s=o.nodeName,n=t.attributes,"#text"===s)a=t.getAttribute("d:constr"),i="Boolean"===a&&"false"===o.textContent?"":o.textContent,a||n.length?a&&1===n.length?l=window[a](i):l[s]=a?window[a](i):i:l=i;else{if(l[s]){l[s].push?l[s].push(e(o)):l[s]=[l[s],e(o)];continue}switch(a=o.getAttribute("d:constr")){case"null":l.push?l.push(null):l[s]=null;break;case"Array":o.parentNode.firstChild===o&&"Array"===o.getAttribute("d:constr")&&"item"!==s?l[s]=[e(o)]:l.push?l.push(e(o)):l[s]=e(o);break;case"String":case"Number":case"Boolean":i="Boolean"===a&&"false"===o.textContent?"":o.textContent,l.push?l.push(window[a](i)):l[s]=e(o);break;default:l.push?l.push(e(o)):l[s]=e(o)}}return l},n=9===this.nodeType?this.documentElement:this,r=e(n),o=r[n.nodeName];return n===n.ownerDocument.documentElement&&o&&o.constructor===Array&&(r=o),t&&"true"==""+t&&(t="	"),t?JSON.stringify(r,null,t):r}),window.JSON||(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var n=0;t.length>n;e+=this.stringify(t[n])+",",n++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var r in t)e+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(t[r])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={repl:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,n){var r,o,s,a,i,l,c=e.constructor===Array,u=[],h=[];for(r in e)if(o=e[r],(null===o||"NaN"==""+o)&&(o=null),a="@"===r.slice(0,1),i=n?t:r,i=i==+i?"item":i,l=null===o?null:o.constructor,a)h.push(i.slice(1)+'="'+this.escape_xml(o)+'"'),"String"!==l.name&&h.push("d:"+i.slice(1)+'="'+l.name+'"');else if(null===o)u.push(this.scalar_to_xml(i,o));else switch(l){case Object:u.push(this.hash_to_xml(i,o));break;case Array:if(r===i){if(s=o.constructor===Array)for(var f=0,d=o.length;d>f;f++)o[f].constructor===Array&&(s=!0),s||o[f].constructor!==Object||(s=!0);u.push(this.scalar_to_xml(i,o,s));break}case String:"string"==typeof o&&(o=(""+o).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===i&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),u.push(this.scalar_to_xml(i,o));break;default:throw"ERROR! "+r}return t||(t="data",h.push(Defiant.namespace),c&&h.push('d:constr="Array"')),n?u.join(""):"<"+t+(h.length?" "+h.join(" "):"")+(u.length?">"+u.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,n){var r,o,s;return(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':n?this.hash_to_xml(t,e,!0):(s=e.constructor,r=s===Array?this.hash_to_xml("item",e,!0):this.escape_xml(e),o=' d:constr="'+s.name+'"',"String"===s.name&&(o=""),"#text"===t?this.escape_xml(e):"<"+t+o+">"+r+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},n=e.to_xml.call(e,t);return e.repl.call(t,n.documentElement.toJSON()),n}),JSON.search||(JSON.search=function(t,e,n){"use strict";var r,o,s,a,i,l=JSON.toXML(t),c=l.documentElement,u=l[n?"selectSingleNode":"selectNodes"](e),h=[],f=[],d=function(t){if(s===h[p].length)return t;switch(t.constructor){case Array:for(var e,n=t.length,r=0;n>r;r++)if(a.val===JSON.stringify(t[r],null,"	")&&h[p].length>s)return s++,a=h[p][s],d(t[r]);if(r===n){if(a.val===JSON.stringify(t,null,"	"))for(s++,a=h[p][s],r=0;n>r;r++)if(e=d(t[r]))return e;return t}break;default:if(t=t[a.key],"object"!=typeof t)return s++,a=h[p][s],t;t.constructor===Object&&(s++,a=h[p][s])}return d(t)};for(n&&(u=[u]),p=0,m=u.length;m>p;p++)if(r=[],o=u[p],o!==c){for(;o!==c;)i=2===o.nodeType,r.push({node:o,key:(i?"@":"")+o.nodeName,val:i?o.value:o.toJSON("	")}),o=i?o.ownerElement:o.parentNode;h.push(r.reverse())}for(var p=0,m=h.length;m>p;p++)s=0,a=h[p][s],f.push(d(t));return this.trace=JSON.search.trace?JSON.mtrace(t,h):!1,f}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var n,r,o,s,a,i,l,c=[],u=JSON.stringify(t,null,"	").notabs(),h=0,f=e.length;f>h;h++){r=e[h],a=0,n=u,o=r.length,s=null===r[o-1].val.match(/[\{\}:\[\]]/g),s&&o--,r[0].val.notabs()!==u&&o>0&&(n=r[0].val.notabs(),a+=u.indexOf(n));for(var d=0,p=o;p>d;d++)a+=n.indexOf(r[d].val.notabs()),n=r[d].val.notabs();s&&(a+=n.indexOf('"'+r[d].key+'": ')),i=u.slice(0,a).count_nl()+1,l=r[s?o:o-1].val.count_nl(),c.push([i,l])}return c}),"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);