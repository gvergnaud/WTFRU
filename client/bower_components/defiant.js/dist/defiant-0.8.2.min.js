/* 
 * Defiant.js v0.8.2 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2013, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
(function(e,t){"use strict";var n={is_safari:null!==navigator.userAgent.match(/safari/i),namespace:'xmlns:defiant="defiant-custom-namespace"',xml_decl:'<?xml version="1.0" encoding="utf-8"?>',render:function(e,n){var r,i,o=new XSLTProcessor,a=t.createElement("span"),s={match:"/"};switch(typeof e){case"object":this.extend(s,e),s.data||(s.data=n);break;case"string":s.template=e,s.data=n;break;default:throw"error"}if(s.data=JSON.toXML(s.data),this.xsl_template||this.gather_templates(),i=this.xsl_template.selectSingleNode('//xsl:template[@name="'+s.template+'"]'),i.setAttribute("match",s.match),o.importStylesheet(this.xsl_template),a.appendChild(o.transformToFragment(s.data,t)),i.removeAttribute("match"),this.is_safari){r=a.getElementsByTagName("script");for(var l=0,c=r.length;c>l;l++)r[l].defer=!0}return a.innerHTML},gather_templates:function(){for(var e=t.getElementsByTagName("script"),n="defiant/xsl-template",r="",i=0,o=e.length;o>i;i++)e[i].type===n&&(r+=e[i].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+r.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(t){var n,r;return t=t.replace(/> {1,}</g,"><"),null===t.match(/<\?xml/)&&(t=this.xml_decl+t),e.DOMParser?(n=new DOMParser,r=n.parseFromString(t,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(t)),r},extend:function(e,t){for(var n in t)e[n]&&"object"==typeof t[n]?this.extend(e[n],t[n]):e[n]=t[n];return e}};e.Defiant=n})(window,document),String.prototype.fill||(String.prototype.fill=function(e,t){var n=this;for(t=t||" ";e>n.length;n+=t);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),Document.selectNodes||(Document.prototype.selectNodes=function(e,t){t||(t=this),this.ns=this.createNSResolver(this.documentElement),this.qI=this.evaluate(e,t,this.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var n=[],r=0,i=n.length;i>r;r++)n[r]=this.qI.snapshotItem(r);return n}),Node.selectNodes||(Node.prototype.selectNodes=function(e){return this.ownerDocument.selectNodes(e,this)}),Document.selectSingleNode||(Document.prototype.selectSingleNode=function(e,t){return t||(t=this),this.xI=this.selectNodes(e,t),this.xI.length>0?this.xI[0]:null}),Node.selectSingleNode||(Node.prototype.selectSingleNode=function(e){return this.ownerDocument.selectSingleNode(e,this)}),Node.xml||Node.prototype.__defineGetter__("xml",function(){for(var e,t,n=new XMLSerializer,r=n.serializeToString(this).replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),i=r.split("\n"),o=-1,a="",s=0,l=i.length;l>s;s++)i[s].toLowerCase()!==Defiant.xml_decl.toLowerCase()&&(e=null!==i[s].match(/<[^\/]+>/g),t=null!==i[s].match(/<\/\w+>/g),null!==i[s].match(/<.*?\/>/g)&&(e=t=!0),e&&o++,i[s]=a.fill(o,"	")+i[s],e&&t&&o--,!e&&t&&o--);return i.join("\n").replace(/\t/g,a.fill(4," "))}),Node.text||(Node.prototype.__defineGetter__("text",function(){return this.textContent}),Node.prototype.__defineSetter__("text",function(e){this.textContent=e})),Node.toJSON||(Node.prototype.toJSON=function(e){var t=function(e){var n,r,i,o={};switch(e.getAttribute&&"array"===e.getAttribute("defiant:type")&&(o=[],e.removeAttribute("type")),"string"==typeof e&&(e=Defiant.xmlFromString(e)),e.nodeType){case 1:if(n=e.attributes,n.length>0)for(var a,s=0,l=n.length;l>s;s++)a=n.item(s),r=a.nodeValue,o["@"+a.nodeName]=r==+r?+r:r;break;case 3:r=e.nodeValue,o=r==+r?+r:r}if(e.hasChildNodes()){i=o.constructor===Array;for(var c=0,h=e.childNodes.length;h>c;c++){var u=e.childNodes.item(c),f=u.nodeName;if(u.childNodes,o[f]===void 0){if("#text"===f){if(r=u.nodeValue,"{}"===JSON.stringify(o))return r==+r?+r:r;o[f]=r}i?o.push(t(u)):o[f]=t(u)}else{if(o[f].push===void 0){var d=o[f];o[f]=[],o[f].push(d)}o[f].push(t(u))}}}else o=null;return o},n=9===this.nodeType?this.documentElement:this,r=t(n);return e?JSON.stringify(r,null,"	"):r}),window.JSON||(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(e){if(e instanceof Object){var t="";if(e.constructor===Array){for(var n=0;e.length>n;t+=this.stringify(e[n])+",",n++);return"["+t.substr(0,t.length-1)+"]"}if(e.toString!==Object.prototype.toString)return'"'+(""+e).replace(/"/g,"\\$&")+'"';for(var r in e)t+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(e[r])+",";return"{"+t.substr(0,t.length-1)+"}"}return"string"==typeof e?'"'+e.replace(/"/g,"\\$&")+'"':e+""}}),JSON.toXML||(JSON.toXML=function(e){var t,n={array_flag:'defiant:type="array"',repl:function(e){for(var t in this)delete this[t];Defiant.extend(this,e)},to_xml:function(e){var t=this.hash_to_xml(null,e).replace(/<\d{1,}>|<\/\d{1,}>/g,"");return Defiant.xmlFromString(t)},hash_to_xml:function(e,n,r){var i,o,a,s,l,c,h,u=[],f=[],d=n.constructor===Array;for(l in n)switch(c=n[l],s=typeof c,h=r?e:l,o="@"===h.slice(0,1),o&&(h=h.slice(1)),!0){case c===void 0||null===c:u.push("<"+(d?"i":h)+" />");break;case"object"===s:i=c.constructor===Array,a=this.hash_to_xml(h,c,i),d&&(t=!0,a="<i "+(i?this.array_flag:"")+">"+a+"</i>"),u.push(a);break;default:o?f.push(h+'="'+this.escape_xml(c)+'"'):u.push(this.scalar_to_xml(h,c,d))}return e||(e="data",(t||d)&&f.push(Defiant.namespace)),d&&f.push(this.array_flag),r?u.join(""):"<"+e+(f.length?" "+f.join(" "):"")+(u.length?">"+u.join("")+"</"+e+">":"/>")},scalar_to_xml:function(e,t,n){return n&&(e="i"),"#text"===e?this.escape_xml(t):"<"+e+">"+this.escape_xml(t)+"</"+e+">"},escape_xml:function(e){return(e+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},r=n.to_xml.call(n,e);return n.repl.call(e,r.documentElement.toJSON()),r}),JSON.search||(JSON.search=function(e,t,n){var r,i,o,a,s,l,c,h,u,f=null===n?[]:!1,d=JSON.toXML(e),p=d[n?"selectSingleNode":"selectNodes"](t),m=[];n&&(p=[p]);for(var g=0,y=p.length;y>g;g++)if(r=[],i=p[g],i!==i.ownerDocument.documentElement){for(o=0;i=i.previousSibling;)o++;for(i=p[g];i!==d.documentElement;)r.push({node:i,key:i.nodeName,val:2===i.nodeType?i.value:i.toJSON(!0),index:o}),i=2===i.nodeType?i.ownerElement:i.parentNode;m.push(r.reverse())}for(g=0,y=m.length;y>g;g++){for(u=e,a=0,l=0,s=0;m[g].length>a;){if(h=m[g][a],u=u[h.key],f&&m[g].length-1>a){var N=h.val.replace(/\t/g,""),x=m[g][a+1].val.replace(/\t/g,""),v=N.indexOf(x);s+=v}if("object"==typeof u&&u.constructor==Array)for(var S=h.index,_=u.length;_>S;S++)if(h.val===JSON.stringify(u[S],null,"	")){u=u[S];break}a++}switch(f&&(l=s?m[g][0].val.replace(/\t/g,"").slice(0,s).match(/\n/g).length:0,c=h.val.match(/\n/g),f.push([l+2,null===c?0:c.length])),h.node.nodeType){case 2:m[g]=h.node.value;break;case 3:m[g]=h.node.text;break;default:m[g]=u||h.val}}return f?this.trace=f:delete this.trace,m}),"undefined"!=typeof jQuery&&function(e){e.fn.defiant=function(e,t){return this.html(Defiant.render(e,t)),this}}(jQuery);